---
title: "P8105 Homework 3"
output: github_document
---

Name: Xi Peng   UNI: xp2213    Date: 10.14.2024

```{r setup, include=FALSE}

library(tidyverse)
library(p8105.datasets)
library(dplyr)
library(patchwork)
library(ggridges)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

```

# Question 1. Exploration of "NY NOAA" dataset

## Section 1: Data cleaning

```{r, message=FALSE}

data("ny_noaa")

weather_dat = ny_noaa |> 
  janitor::clean_names() |> 
  separate(date, into = c('year', 'month', 'day'), remove = TRUE) |>
  mutate(
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin)
  )

snow_comm = weather_dat |> 
  group_by(snow,id) |> 
  summarise(count = n()) |> 
  arrange(desc(count))
  
```

In the original "ny_noaa" datasets, there are `r nrow(ny_noaa)` observations and there are `r ncol(ny_noaa)` variables included, which are: `r names(ny_noaa)`. In this section, the "date" variable was separated into year, month, and day. Temperature ("tman" and "tmin"), precipitation ("prcp"), and snowfall("snow") were tranfered into reasonable units.

By checking the "snow" variable for snowfall, the result shows that `0 cm` and `NA` are the most commonly observed values. The likely reason is that for most of the year, these regions do not experience snowfall, especially during warmer months. Additionally, some regions included in the dataset may not experience snow at all throughout the year due to their warmer climates or geographical location. These places are unlikely to have a snow season, and as a result, `0 cm` is consistently recorded for snowfall in these areas. The presence of `NA` values indicates missing data, which could be due to weather stations not recording snowfall on certain days or data collection issues.


## Section 2: Comparison of mean maximum temperature in January and July across weather stations over the years

```{r}

weather_jan_jul = weather_dat |> 
  group_by(id, year, month) |> 
  mutate(
    month = as.numeric(month),
    year = as.numeric(year)
         ) |>
  filter(month %in% c(1, 7)) |>
  summarise(mean_tmax = mean(tmax, na.rm = TRUE, color = id))
 
weather_jan_jul_ggplot = weather_jan_jul |> 
ggplot(aes(x = year, y = mean_tmax, group = id)) +
  geom_point() + geom_path() +
  facet_grid(~month) +
  scale_x_continuous(breaks = seq(min(weather_jan_jul$year), max(weather_jan_jul$year), by = 10)) +
  labs(
    title = "Mean Max Temperature in January and July by Stations",
       x = "Year", 
       y = "Mean Max Temperature (°C)") 

weather_jan_jul_ggplot
```

I checked the dataset and recognized there are `r length(unique(pull(weather_dat,id)))` stations. One issue that needed attention is the large number of stations in the dataset. Including all the station labels would result in the scatterplot not being displayed properly because of the excessive number of stations in the legend.

According to the scatterplot, there are clear seasonal differences between January and July temperatures. The temperatures are generally colder in January, and warmer in July across stations and years. Due to the large number of stations included in this dataset, without restricting the analysis to a specific time range or a particular set of stations, I can only observe general trends. The observable structure shows that temperatures in January typically range from -10 °C to 10 °C, where temperatures in July typically ranger from 20 °C to 32.5 °C. Comparing 1981 to 2010, there appears to be a slight increase in temperatures for both January and July, suggesting a possible warming trend over time.There's considerable variability both between stations and from year to year, illustrating geographical and annual climate differences. There are several noticeable outlines. For example, in January 1982 and 1996, some stations recorded average maximum temperatures below -10 °C, reflecting extremely cold winters. Also, one station in July 1988 recorded unusually low average temperature, far below the general trend. These anomalies could indicate extreme weather events or errors in data recording.


## Section 3: Analysis of temperature extremes and distribution of snowfall patterns

```{r, message=FALSE, warning=FALSE}

tmax_vs_tmin_panel = weather_dat |> 
  ggplot(aes(x = tmin, y = tmax)) +
  geom_hex() +
  labs(
    title = "Temperature Comparison: tmax vs tmin",
    x = "Minimum Temperature (°C)",
    y = "Maximum Temperature (°C)"
  ) 

snowfall_distri_panel = weather_dat |> 
  filter(snow < 100, snow > 0) |> 
  ggplot(aes(x = snow, y = as.factor(year))) +
  geom_density_ridges() +
  labs(
    subtitle = "Distribution of snowfall values by year",
    x = "Snow",
    y = "as.factor(year)"
  ) 

tmax_vs_tmin_panel + snowfall_distri_panel
```



# Question 2. Analysis of accelerometer data from the NHANES study

## Section 1: Dataset import and organization

```{r}

nhanes_covar_df =
    read_csv("Data/nhanes_covar.csv", na = c("NA", "", ".", " "), skip = 4) |> 
    janitor::clean_names() |> 
  drop_na() |> 
  mutate( education = as.character(education), sex = as.character(sex)
  ) |> 
    mutate(
      education = case_match(
        education,
        "1" ~ "Less than high school",
        "2" ~ "High school equivalent",
        "3" ~ "More than high school"),
      sex = case_match(
        sex,
        "1" ~ "Male",
        "2" ~ "Female"
      ))
    
nhanes_accel_df =
    read_csv("Data/nhanes_accel.csv", na = c("NA", "", ".", " ")) |> 
  janitor::clean_names()

Merged_nhanes_dat = nhanes_covar_df |> 
  inner_join(nhanes_accel_df, by = "seqn") |> 
  filter(age > 21) |> 
  mutate(
    sex = factor(sex, levels = c("Male", "Female")),
    Education = factor(education, levels = c(
      "Less than high school",
      "High school equivalent",
      "More than high school"
    )))

```

In this section, the datasets were cleaned and organized as per the requirements, and a merged dataset was created.

## Section 2: Gender distribution and age trends across education categories

```{r, message=FALSE, fig.width = 12}

Sex_in_education_cate = Merged_nhanes_dat |> 
  group_by(Education, sex) |> 
  summarise(count = n()) |> 
  pivot_wider(
    names_from = sex,
    values_from = count
  )

knitr::kable(Sex_in_education_cate, caption = "Number of Men and Women in Each Education Category")

Age_distri_in_Edc_plot = Merged_nhanes_dat |> 
  ggplot(aes(x = age, fill = sex)) +
  geom_density(alpha = 0.5) +
  facet_grid(~Education) +
  labs(
    title = "Age Distribution by Education and Gender",
    x = "Age",
    y = "Density"
  ) 

Age_distri_in_Edc_plot2 = Merged_nhanes_dat |> 
  ggplot(aes(x = age, fill = sex)) +
 geom_histogram(position = "dodge", binwidth = 2) +
  facet_grid(~Education) +
  labs(
    title = "Age Distribution by Education and Gender",
    x = "Age",
    y = "Density"
  )

Age_distri_in_Edc_plot
Age_distri_in_Edc_plot2
```


